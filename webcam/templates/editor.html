{% extends 'layout.html' %}
{% load social_share %}
{% block body %}
<div>
    <div class="screen">
        <canvas id="myCanvas"></canvas>
    </div>
    <div class="flexrow">
        <form action="" method="post">
            {% csrf_token %}
            <input id="photo_edited" type="hidden" name="photo_edited" value="">
            <input class="btn btn-primary" type="submit" value="Save Your Photo">
        </form>
        <a href="" class="btn btn-primary" onclick="download_image()" id="download">DOWNLOAD</a>    
    </div>
    
    <div class="flexrow">
        <button id=s0 class="sticker">Clear Sticker!</button>
        {% for emoji in emojis %}
        <img src="{{ emoji.emoji }}" alt="{{ emoji.pk }}" width="40" height="40" id="{{ emoji.id }}" class="sticker">
        {% endfor %}
    </div>

    <div class="flexrow">
        {% post_to_facebook object_or_url "Post to Facebook!" "btn btn-primary" %}
    </div>

</div>

<script>
    var imgWidth = sessionStorage.getItem("imgWidth");
    var imgHeight = sessionStorage.getItem("imgHeight");
    var strDataURI = '{{ photo.photo_edited }}';
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    var guessX = 0;
    var guessY = 0;

    if (imgHeight != "" && imgWidth != "") {
        c.width = imgWidth;
        c.height = imgHeight;
    }
    else{
        c.width = "300px";
        c.height = "300px";
    }
    // c.width = imgWidth;
    // c.height = imgHeight;

    function draw_image(ctx, strDataURI, dx, dy, dWidth, dHeight) {
        var img = new Image;
        img.src = strDataURI;
        img.onload = function(){
            ctx.drawImage(img, dx, dy, dWidth, dHeight);
    }};
    draw_image(ctx, strDataURI, 0, 0, imgWidth, imgHeight);

    myCanvas.addEventListener('click', function storeGuess(event) {
        var x = event.offsetX;
        var y = event.offsetY;
        guessX = x;
        guessY = y;
        console.log("x coords: " + guessX + ", y coords: " + guessY);
        // alert(guessX + ", " + guessY);
        draw_image(ctx, emoji_uri, guessX, guessY, imgWidth/10, imgHeight/10)
        image_co_data = c.toDataURL( "image/png" );
        document.getElementById('photo_edited').value = image_co_data
    });

    function download_image(){
        image = c.toDataURL("image/png").replace("image/png", "image/octet-stream");
        var link = document.createElement('a');
        link.download = "my-image.png";
        link.href = image;
        link.click();
    };

    function removeClasses(one) {
      one.classList.remove('selected')
    };

    let emoji_uri = '';
    let current_sticker = '';
    const buttons = document.querySelectorAll(".sticker")
    for (const button of buttons) {
    button.addEventListener('click', function(event) {
        buttons.forEach(removeClasses);
        document.querySelectorAll(".frame")
        button.classList.add("selected")
        if (button.id != 's0') {
            current_sticker = button.id
            emoji_uri = button.src
            console.log(current_sticker)
        }
        else if (button.id === 's0') {
            current_sticker = ''
            emoji_uri = ''
            console.log(current_sticker)
        }
    })
    };

// emoji_uri = getValueofSelected(".sticker", 's0')
</script>

{% endblock %}
